# ğŸ‘¤ ExibiÃ§Ã£o do UsuÃ¡rio Logado no Header

## ğŸ“‹ VisÃ£o Geral

Este documento descreve a implementaÃ§Ã£o da exibiÃ§Ã£o do usuÃ¡rio logado no componente `Header.tsx`, incluindo a correÃ§Ã£o para exibir o campo `usuario` da tabela `tbusuario`.

---

## ğŸ¯ Objetivo

Exibir corretamente o **e-mail do usuÃ¡rio logado** (de `auth.users.email`) no dropdown de perfil do Header, junto com:
- Nome do funcionÃ¡rio (de `tbfuncionario`)
- Cargo do funcionÃ¡rio (de `tbfuncionario`)
- MatrÃ­cula do funcionÃ¡rio (de `tbfuncionario`)

**âš ï¸ IMPORTANTE:** O campo `tbusuario.usuario` armazena o **nome visual do usuÃ¡rio**, nÃ£o o e-mail!

---

## ğŸ—„ï¸ Estrutura das Tabelas

### Tabela `tbusuario`

```sql
CREATE TABLE tbusuario (
    usuario_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() AT TIME ZONE 'America/Fortaleza'::text),
    usuario TEXT NULL,  -- â­ Email do usuÃ¡rio (campo principal para exibiÃ§Ã£o)
    user_id UUID NULL REFERENCES auth.users(id),  -- VÃ­nculo com Supabase Auth
    perfil_id INTEGER NULL,
    deletado TEXT NULL DEFAULT 'N',  -- Soft delete: 'N' ou 'S'
    funcionario_id INTEGER NULL REFERENCES tbfuncionario(funcionario_id),
    parceiro_id INTEGER NULL REFERENCES tbparceiro(parceiro_id),
    created_by INTEGER NULL REFERENCES tbusuario(usuario_id),
    updated_at TIMESTAMP WITHOUT TIME ZONE NULL,
    updated_by INTEGER NULL REFERENCES tbusuario(usuario_id),
    updated_nome TEXT NULL,
    deleted_at TIMESTAMP WITHOUT TIME ZONE NULL,
    deleted_by INTEGER NULL REFERENCES tbusuario(usuario_id),
    deleted_nome TEXT NULL
);
```

**Campos-chave:**
- `usuario_id` (INTEGER): Chave primÃ¡ria sequencial
- `usuario` (TEXT): **Nome visual do usuÃ¡rio** - usado para exibiÃ§Ã£o (ex: "Emanuel Silva")
- `user_id` (UUID): VÃ­nculo com `auth.users.id` do Supabase Auth
- `funcionario_id` (INTEGER): VÃ­nculo com `tbfuncionario` para obter dados do funcionÃ¡rio
- `deletado` (TEXT): Soft delete ('N' = ativo, 'S' = deletado)

### Relacionamentos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auth.users     â”‚         â”‚    tbusuario     â”‚         â”‚  tbfuncionario  â”‚
â”‚  (Supabase)     â”‚         â”‚                  â”‚         â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID) â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ user_id (UUID)   â”‚         â”‚ funcionario_id  â”‚
â”‚ email           â”‚         â”‚ usuario (TEXT)   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ (INTEGER PK)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ funcionario_id â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ nome            â”‚
                            â”‚ deletado         â”‚         â”‚ cargo           â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ matricula       â”‚
                                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» ImplementaÃ§Ã£o no Header.tsx

### Interface `UsuarioPerfil`

```typescript
interface UsuarioPerfil {
  nome: string;
  cargo?: string;
  email?: string; // â­ Email do usuÃ¡rio (de auth.users.email)
  matricula?: string;
}
```

### Query de Carregamento

```typescript
const { data: usuarios, error: usuarioError } = await supabase
  .from('tbusuario')
  .select(`
    usuario_id,
    usuario,           // Nome visual do usuÃ¡rio (nÃ£o Ã© o e-mail)
    funcionario_id,
    perfil_id,
    tbfuncionario:funcionario_id (
      matricula,
      cargo,
      nome
    )
  `)
  .eq('user_id', session.user.id)  // Filtra pelo UUID do Supabase Auth
  .eq('deletado', 'N')              // â­ Apenas usuÃ¡rios ativos
  .limit(1);
```

### Montagem do Perfil

```typescript
const usuario = usuarios?.[0];
// O join retorna um array, entÃ£o pegamos o primeiro elemento
const funcionarioArray = usuario?.tbfuncionario as any;
const funcionario = Array.isArray(funcionarioArray) ? funcionarioArray[0] : funcionarioArray;

const perfil: UsuarioPerfil = {
  nome: funcionario?.nome || fallbackPerfil.nome || 'UsuÃ¡rio',
  cargo: funcionario?.cargo || fallbackPerfil.cargo || 'Colaborador',
  email: session.user.email || fallbackPerfil.email || '',  // â­ Email de auth.users
  matricula: funcionario?.matricula || fallbackPerfil.matricula || ''
};
```

### ExibiÃ§Ã£o no Dropdown

```tsx
const emailExibicao = perfilUsuario?.email || 'Email nÃ£o encontrado';

<DropdownMenuLabel>
  <div className="flex flex-col space-y-1">
    <p className="text-sm font-medium leading-none break-all">
      {emailExibicao}  {/* â­ Exibe o email de auth.users */}
    </p>
    <p className="text-xs leading-none text-muted-foreground">
      MatrÃ­cula: {matriculaExibicao}
    </p>
  </div>
</DropdownMenuLabel>
```

---

## âœ… Checklist de ValidaÃ§Ã£o

- [x] Campo `email` da interface `UsuarioPerfil` definido
- [x] Email obtido de `session.user.email` (auth.users)
- [x] Filtro `deletado = 'N'` aplicado na query
- [x] Join com `tbfuncionario` atravÃ©s de `funcionario_id`
- [x] Array do join tratado corretamente
- [x] VariÃ¡vel `emailExibicao` criada
- [x] Dropdown exibe `emailExibicao` corretamente
- [x] Fallback para `session.user.email` configurado
- [x] DocumentaÃ§Ã£o atualizada

---

## ğŸ” Fluxo de Dados

1. **AutenticaÃ§Ã£o:** UsuÃ¡rio faz login via Supabase Auth
2. **SessÃ£o:** `supabase.auth.getSession()` retorna `session.user` com `id` (UUID) e `email`
3. **Busca em tbusuario:** Query filtra por `user_id = session.user.id` e `deletado = 'N'`
4. **Join com tbfuncionario:** ObtÃ©m `nome`, `cargo` e `matricula` via `funcionario_id`
5. **Montagem do perfil:** Combina dados de `tbfuncionario` + `session.user.email`
6. **ExibiÃ§Ã£o:** Mostra `session.user.email` no dropdown do Header

---

## ğŸ› Troubleshooting

### Problema: Email nÃ£o aparece no dropdown

**PossÃ­veis causas:**
1. SessÃ£o do Supabase Auth nÃ£o estÃ¡ ativa
2. `session.user.email` estÃ¡ vazio
3. Registro do usuÃ¡rio tem `deletado = 'S'`
4. `user_id` nÃ£o estÃ¡ vinculado corretamente ao `auth.users.id`

**SoluÃ§Ã£o:**
```sql
-- Verificar dados do usuÃ¡rio
SELECT
  u.usuario_id,
  u.usuario,
  u.user_id,
  u.deletado,
  u.funcionario_id,
  a.email as auth_email
FROM tbusuario u
INNER JOIN auth.users a ON a.id = u.user_id
WHERE a.email = 'email@exemplo.com';

-- Verificar se user_id estÃ¡ vinculado
UPDATE tbusuario u
SET user_id = a.id
FROM auth.users a
WHERE u.usuario = a.email
AND u.user_id IS NULL;
```

### Problema: MatrÃ­cula ou cargo nÃ£o aparecem

**Causa:** `funcionario_id` nÃ£o estÃ¡ vinculado ou funcionÃ¡rio nÃ£o existe

**SoluÃ§Ã£o:**
```sql
-- Verificar vÃ­nculo
SELECT 
  u.usuario_id,
  u.usuario,
  u.funcionario_id,
  f.nome,
  f.cargo,
  f.matricula
FROM tbusuario u
LEFT JOIN tbfuncionario f ON u.funcionario_id = f.funcionario_id
WHERE u.user_id = 'UUID_DO_USUARIO_LOGADO';
```

---

## ğŸ“ Notas Importantes

1. **Campo `tbusuario.usuario`:** Armazena o **nome visual do usuÃ¡rio** (ex: "Emanuel Silva"), NÃƒO o e-mail

2. **Email do usuÃ¡rio:** Vem de `session.user.email` (tabela `auth.users`), nÃ£o de `tbusuario.usuario`

3. **Soft Delete:** Sempre filtrar por `deletado = 'N'` para evitar exibir usuÃ¡rios inativos

4. **Join com tbfuncionario:** O join Ã© feito atravÃ©s de `funcionario_id`, nÃ£o por matrÃ­cula ou email

5. **Array do Join:** O Supabase retorna o join como array, entÃ£o Ã© necessÃ¡rio acessar `[0]`

---

**Ãšltima atualizaÃ§Ã£o:** 05/12/2024

